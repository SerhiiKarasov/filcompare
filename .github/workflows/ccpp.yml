name: filcompare

on: [push, pull_request]

jobs:
  gcc-build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler_version:
          - 9
          - 10
          - 11
          - 12
        build_type:
          - Release

    steps:
      - uses: actions/checkout@v3
        with:
          submodules: 'recursive'
      - name: docker_image_build
        run: docker build --build-arg GCC_VERSION=${{ matrix.compiler_version }} -t build_filcompare .
      - name: run_build_in_docker
        run: docker run --user $(id -u):$(id -g) -v $PWD:/opt/project build_filcompare

  check-cmake-format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: 'recursive'
      - name: docker_image_build
        run: docker build -t build_filcompare .
      - name: cmake_format
        run: |
          docker run --user $(id -u):$(id -g) -v $PWD:/opt/project build_filcompare python3 -m cmakelang.format -c .cmake-format.yaml \
          --check CMakeLists.txt tests/CMakeLists.txt src/CMakeLists.txt submodules/CMakeLists.txt src/sqlite_lib_own_implementation/CMakeLists.txt src/sqlitecpp_lib/CMakeLists.txt

  cppcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: 'recursive'
      - name: docker_image_build
        run: docker build -t build_filcompare .
      - name: cppcheck-ver
        run: docker run --user $(id -u):$(id -g) -v $PWD:/opt/project build_filcompare cppcheck --version
      - name: cppcheck
        run: docker run --user $(id -u):$(id -g) -v $PWD:/opt/project build_filcompare cppcheck --error-exitcode=0 --force --include=/usr/include --suppress=missingIncludeSystem --enable=all src/

  cpplint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: 'recursive'
      - name: docker_image_build
        run: docker build -t build_filcompare .
      - name: cpplint
        run: docker run --user $(id -u):$(id -g) -v $PWD:/opt/project build_filcompare cpplint --filter=-whitespace,-readability,-legal,-build/include_order src/*pp

  clang-tidy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: 'recursive'
      - name: docker_image_build
        run: docker build -t build_filcompare .
      - name: Clang build
        run: |
          docker run \
            --user $(id -u):$(id -g)                   \
            -v $PWD:/opt/project                       \
            -e CC=/usr/bin/clang                       \
            -e CXX=/usr/bin/clang++                    \
            build_filcompare

      - name: clang-tidy
        run: docker run --rm --user $(id -u):$(id -g) -v $PWD:/opt/project build_filcompare clang-tidy -p build/ -header-filter=.* -extra-arg=-std=c++17 -checks=*,-fuchsia*,-hicpp*,-llvm-header-guard,-llvm-include-order,-google-readability-braces-around-statements,-readability-avoid-const-params-in-decls,-modernize-use-trailing-return-type,-llvmlibc* src/*pp
